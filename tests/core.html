<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<script src="http://code.jquery.com/jquery-latest.js"></script>
	<link rel="stylesheet" href="http://code.jquery.com/qunit/git/qunit.css" type="text/css" media="screen" />
	<script type="text/javascript" src="http://code.jquery.com/qunit/git/qunit.js"></script>
	<script type="text/javascript" src="../crafty.js"></script>

<script>
$(document).ready(function() {
	var first = Crafty.e("test");
	Crafty.e("test");
	Crafty.e("test");
	Crafty.e("test");
	
	Crafty.e("test2");
	Crafty.e("test2");
	Crafty.e("test2");
	Crafty.e("test2");
	
	Crafty.e("test, test2");
	Crafty.e("test, test2");
	Crafty.e("test, test2");
	Crafty.e("test, test2");
	
	Crafty.c("comp", {
		added: true
	});
	
	module("CORE");
		
	test("selectors", function() {
		equals( Crafty("test").length, 8, "Single component" );
		equals( Crafty("test test2").length, 4, "Two components ANDed" );
		equals( Crafty("test, test2").length, 12, "Two components ORed" );
		
		equals( Crafty("*").length, 13, "All components - universal selector" );
		
		equals( Crafty(1), first, "Get by ID" );
	});
	
	test("addComponent", function() {
		first.addComponent("test3");
		equals( first.has("test3"), true, "component added" );
		
		first.addComponent("comp");
		equals( first.added, true, "component with property exists" );
		
		first.addComponent("multi1, multi2");
		equals( first.has("multi1") && first.has("multi2"), true, "multiple components added" );
	});
	
	test("removeComponent", function() {
		first.removeComponent("test3");
		equals( first.has("test3"), false, "component removed");
		
		first.removeComponent("comp");
		equals( first.added && !first.has("comp"), true, "component not haz but properties remain" );
	});
	
	test("attr", function() {
		first.attr("single", true);
		equals( first.single, true, "single attribute assigned" );
		
		first.attr({prop: "test", another: 56});
		equals( first.prop, "test", "properties from object assigned" );
		equals( first.another, 56, "properties from object assigned" );
	});

    test("setter", function() {
        first.setter('p1', function(v) {this._p1 = v*2 });
        first.p1 = 2;
        equals(first._p1, 4, "single property setter");

        first.setter('p2', function(v) {this._p2 = v*2 }).setter('p3', function(v) {this._p3 = v*2 });
        first.p2 = 2;
        first.p3 = 3;
        equals(first._p2 + first._p3, 10, "two property setters");
    });
	
	test("bind", function() {
		first.bind("myevent", function() {
			ok(true, "Custom event");
		});
	});
	
	test("trigger", function() {
		first.trigger("myevent");
	});
	
	test("unbind", function() {
		first.bind("myevent", function() {
			ok(false, "This should not be triggered (unbinding all)");
		});
		first.unbind("myevent");
		first.trigger("myevent");
		
		function callback() {
			ok(false, "This should also not be triggered (unbind by FN)");
		}
		
		function callback2() {
			ok(true, "This should be triggered");
		}
		
		first.bind("myevent", callback);
		first.bind("myevent", callback2);
		first.unbind("myevent", callback);
		first.trigger("myevent");
	});
	
	test("each", function() {
		var count = 0;
		Crafty("test").each(function(i) {
			count++;
		});
		equals(count, 8, "Iterated all elements");
	});
	
	test("requires", function() {
		Crafty.c("already", {
			already: true
		});
		Crafty.c("notyet", {
			notyet: true
		});
		
		first.addComponent("already");
		first.already = "already";
		
		first.requires("already, notyet");
		
		equals(first.already, "already", "Didn't overwrite property");
		equals(first.notyet, true, "Assigned if didn't have");
		ok(first.has("already") && first.has("notyet"), "Both added");
	});
	
	test("destroy", function() {
		var id = first[0]; //id
		first.destroy();
		equals(Crafty(id).length, 0, "Not listed");
	});
	
	module("2D");
	
	Crafty.init();
	var player = Crafty.e("2D, DOM, Color").attr({w:50, h: 50}).color("red");
	
	test("position", function() {
		player.x += 50;
		equals(player._x, 50, "X moved");
		
		player.y += 50;
		equals(player._y, 50, "Y moved");
		
		player.w += 50;
		equals(player._w, 100, "Width increase");
		
		player.h += 50;
		equals(player._h, 100, "Height increase");
		
		equals(player._global, 13, "Global Z, Before");
		
		player.z = 1;
		equals(player._z, 1, "Z index");
		
		equals(player._global, 100013, "Global Z, After");
	});
	
	test("intersect", function() {
		player.x = 0;
		player.y = 0;
		player.w = 50;
		player.h = 50;
		
		equals(player.intersect(0, 0, 100, 50), true, "Intersected");

		equals(player.intersect({x: 0, y: 0, w: 100, h: 50}), true, "Intersected Again");

		equals(player.intersect(100, 100, 100, 50), false, "Didn't intersect");
	});
	
	test("circle", function() {
		var circle = new Crafty.circle(0, 0, 10);
		
		equals(circle.containsPoint(1, 2), true, "Contained the point");
		equals(circle.containsPoint(8, 9), false, "Didn't contain the point");
		
		circle.shift(1, 0);
		
		equals(circle.x, 1, "Shifted of one pixel on the x axis");
		equals(circle.y, 0, "circle.y didn't change");
		equals(circle.radius, 10, "circle.radius didn't change");
	});

	module("Storage");

	test("saveAndLoadObject", function() {
		Crafty.storage.open("MyGame");
		Crafty.storage.save("LeaderBoard", "save", {name: "Matthew", score: 150});
		console.log("111");
		stop();
		Crafty.storage.load("LeaderBoard", "save", function(lb) {
			console.log("222");
				equals(lb["name"], "Matthew");
			start();
		});
		console.log("333");
	});

	test("saveAndLoadArray", function() {
		Crafty.storage.open("MyGame1");
		Crafty.storage.save("LeaderBoard", "save", [{name: "Matthew", score: 150}, {name: "Louis", score: 17}]);
		stop();
		Crafty.storage.load("LeaderBoard", "save", function(lb) {
			equals(lb[1]["name"], "Louis");
			equals(lb.length, 2);
			start();
		});
	});

	test("saveAndLoadEntity", function() {
		Crafty.storage.open("MyGame2");
		Crafty.storage.save("Hero", "save", Crafty.e("2D, DOM").attr({x:20, y:137}));
		stop();
		Crafty.storage.load("Hero", "save", function(hero) {
			console.log(hero);
			ok(hero.__c["2D"]);
			ok(hero.__c["DOM"])
			equals(hero.x, 0, "Entity state is not saved");
			start();
		});
	});

	test("individualNamespaces", function() {
		Crafty.storage.open("MyGame3");
		Crafty.storage.save("LeaderBoard", "save", {name: "Matthew", score: 150});


		Crafty.storage.open("MyGame4");
		Crafty.storage.save("LeaderBoard", "save", {name: "Louis", score: 150});

		stop();
		Crafty.storage.load("LeaderBoard", "save", function(lb) {
			equals(lb["name"], "Louis");
			start();
		});

		stop(500);
		Crafty.storage.open("MyGame3");
		Crafty.storage.load("LeaderBoard", "save", function(lb) {
			equals(lb["name"], "Matthew");
			start();
		});
	})

});
</script>
  
</head>
<body>
<h1 id="qunit-header">Crafty: Core</h1>
<h2 id="qunit-banner"></h2>
<div id="qunit-testrunner-toolbar"></div>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>
<div id="qunit-fixture">test markup, will be hidden</div>
</body>
</html>