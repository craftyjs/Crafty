/*
 * Crafty v0.3
 * http://craftyjs.com
 *
 * Copyright 2010, Louis Stowasser
 * Dual licensed under the MIT or GPL licenses.
 */
(function(j,e){var m=function(r){return new m.fn.init(r)},i=1,n=50,c=1,g={},h={},d={},p=[],b,f,o=Array.prototype.slice,k=/\s*,\s*/,q=/\s+/;m.fn=m.prototype={init:function(v){if(typeof v==="string"){var t=0,z,A,y=false,x=false,B;if(v==="*"){for(z in h){this[+z]=h[z];t++}this.length=t;return this}if(v.indexOf(",")!==-1){x=true;B=k}else{if(v.indexOf(" ")!==-1){y=true;B=q}}for(z in h){if(!h.hasOwnProperty(z)){continue}A=h[z];if(y||x){var r=v.split(B),w=0,u=r.length,s=0;for(;w<u;w++){if(A.__c[r[w]]){s++}}if(y&&s===u||x&&s>0){this[t++]=+z}}else{if(A.__c[v]){this[t++]=+z}}}if(t>0&&!y&&!x){this.extend(g[v])}if(r&&y){for(w=0;w<u;w++){this.extend(g[r[w]])}}this.length=t}else{if(!v){v=0;if(!(v in h)){h[v]=this}}if(!(v in h)){this.length=0;return this}this[0]=v;this.length=1;if(!this.__c){this.__c={}}if(!h[v]){h[v]=this}return h[v]}return this},addComponent:function(x){var u=[],w=0,t;if(arguments.length>1){var s=0,r=arguments.length;for(;s<r;s++){this.__c[arguments[s]]=true;u.push(arguments[s])}}else{if(x.indexOf(",")!==-1){var v=x.split(k),s=0,r=v.length;for(;s<r;s++){this.__c[v[s]]=true;u.push(v[s])}}else{this.__c[x]=true;u.push(x)}}t=u.length;for(;w<t;w++){comp=g[u[w]];this.extend(comp);if(comp&&"init" in comp){comp.init.call(this)}}return this},removeComponent:function(r){delete this.__c[r];return this},has:function(r){return !!this.__c[r]},attr:function(r,s){if(arguments.length===1){if(typeof r==="string"){return this[r]}this.extend(r);this.trigger("change");return this}this[r]=s;this.trigger("change");return this},toArray:function(){return o.call(this,0)},delay:function(r,s){this.each(function(){var t=this;setTimeout(function(){r.call(t)},s)})},bind:function(t,s){if(this.length===1){if(!d[t]){d[t]={}}var r=d[t];if(!r[this[0]]){r[this[0]]=[]}r[this[0]].push(s);return this}this.each(function(){if(!d[t]){d[t]={}}var u=d[t];if(!u[this[0]]){u[this[0]]=[]}u[this[0]].push(s)});return this},unbind:function(s,r){this.each(function(){var v=d[s],u=0,t,w;if(v[this[0]]){t=v[this[0]].length}else{return this}if(t===1||!r){delete v[this[0]];return this}for(;u<t;u++){w=v[this[0]];if(w[u]==r){w.splice(u,1);u--}}});return this},trigger:function(u,v){if(this.length===1){if(d[u]&&d[u][this[0]]){var t=d[u][this[0]],s=0,r=t.length;for(;s<r;s++){t[s].call(this,v)}}return this}this.each(function(){if(d[u]&&d[u][this[0]]){var y=d[u][this[0]],x=0,w=y.length;for(;x<w;x++){y[x].call(this,v)}}});return this},each:function(t){var s=0,r=this.length;for(;s<r;s++){t.call(h[this[s]],s)}return this},destroy:function(){this.each(function(){this.trigger("remove");for(var r in d){this.unbind(r)}delete h[this[0]]})}};m.fn.init.prototype=m.fn;m.extend=m.fn.extend=function(s){var r=this;if(!s){return r}for(key in s){if(r===s[key]){continue}r[key]=s[key]}return r};m.extend({init:function(t,r,s){if(arguments.length===2){s=r;r=t;t=100}n=t||100;m.viewport.init(r,s);this.onload();this.timer.init()},stop:function(){clearInterval(f)},timer:{prev:(+new Date),current:(+new Date),fps:0,init:function(){var r;if(j.webkitRequestAnimationFrame){r=function(s){var t=function(){s();webkitRequestAnimationFrame(t)};t()}}else{if(j.mozRequestAnimationFrame){r=function(s){var t=function(){s();mozRequestAnimationFrame(t)};t()}}else{r=function(s){setInterval(s,1000/n)}}}r(m.timer.step)},step:(function(){var r=0,s=1000/n,t=(new Date).getTime();return function(){r=0;this.prev=this.current;this.current=(+new Date);while((new Date).getTime()>t){m.trigger("enterframe",{frame:c++});t+=s;r++;this.fps=r/this.fpsUpdateFrequency}if(r){m.DrawList.draw()}}})(),getFPS:function(){return this.fps}},e:function(){var s=a(),r;h[s]=null;h[s]=r=m(s);if(arguments.length>0){r.addComponent.apply(r,arguments)}r.addComponent("obj");return r},c:function(s,r){g[s]=r},trigger:function(v,w){var u=d[v],t,s,r;for(t in u){if(!u.hasOwnProperty(t)){continue}r=u[t].length;for(s=0;s<r;s++){if(u[t]&&u[t][s]){u[t][s].call(m(+t),w)}}}},frame:function(){return c},onload:function(s,u){if(!arguments.length){var t=0,r=p.length,v;for(;t<r;++t){v=p[t];if(v){v.fn.call(v.ctx)}}return this}p.push({ctx:s,fn:u});return this},components:function(){return g}});function a(){var r=i++;if(r in h){return a()}return r}j.Crafty=m})(window);(function(g,c,f){(function(o){var n,q=function(s){n=s||64;this.map={}},r=Math,e=r.floor,m=r.ceil,p=" ";q.prototype={insert:function(x){var v=q.key(x),u=new k(v,x,this),t=0,s,w;for(t=v.x1;t<=v.x2;t++){for(s=v.y1;s<=v.y2;s++){w=t+p+s;if(!this.map[w]){this.map[w]=[]}this.map[w].push(x)}}return u},search:function(A,t){var B=q.key(A),z,v,x,y,s,w=[],u=[],C={};if(t===undefined){t=true}for(z=B.x1;z<=B.x2;z++){for(v=B.y1;v<=B.y2;v++){x=z+p+v;if(this.map[x]){w=w.concat(this.map[x])}}}if(t){for(z=0,l=w.length;z<l;z++){y=w[z];if(!y){continue}s=y[0];if(!C[s]&&y.x<A._x+A._w&&y._x+y._w>A._x&&y.y<A._y+A._h&&y._h+y._y>A._y){C[s]=w[z]}}for(y in C){u.push(C[y])}return u}else{return w}},remove:function(w,y){var v=0,u,x;if(arguments.length==1){y=w;w=q.key(y)}for(v=w.x1;v<=w.x2;v++){for(u=w.y1;u<=w.y2;u++){x=v+p+u;if(this.map[x]){var t=this.map[x],s=0,z=t.length;for(;s<z;s++){if(t[s]&&t[s][0]===y[0]){t.splice(s,1)}}}}}}};q.key=function(w){var t=e(w._x/n),v=e(w._y/n),s=e((w._w+w._x)/n),u=e((w._h+w._y)/n);return{x1:t,y1:v,x2:s,y2:u}};q.hash=function(s){return s.x1+p+s.y1+p+s.x2+p+s.y2};function k(s,u,t){this.keys=s;this.map=t;this.obj=u}k.prototype={update:function(s){if(q.hash(q.key(s))!=q.hash(this.keys)){this.map.remove(this.keys,this.obj);var t=this.map.insert(this.obj);this.keys=t.keys}}};o.HashMap=q})(g);g.map=new g.HashMap();var d=Math,i=d.cos,a=d.sin,j=d.PI,h=j/180;g.c("2D",{_x:0,_y:0,_w:0,_h:0,_z:0,_rotation:0,_alpha:1,_visible:true,_global:null,_origin:null,_mbr:null,_entry:null,_attachy:[],_changed:false,_offscreen:false,init:function(){this._global=this[0];this._origin={x:0,y:0};if(g.support.setter){this.__defineSetter__("x",function(e){this._attr("_x",e)});this.__defineSetter__("y",function(e){this._attr("_y",e)});this.__defineSetter__("w",function(e){this._attr("_w",e)});this.__defineSetter__("h",function(e){this._attr("_h",e)});this.__defineSetter__("z",function(e){this._attr("_z",e)});this.__defineSetter__("rotation",function(e){this._attr("_rotation",e)});this.__defineSetter__("alpha",function(e){this._attr("_alpha",e)});this.__defineSetter__("visible",function(e){this._attr("_visible",e)});this.__defineGetter__("x",function(){return this._x});this.__defineGetter__("y",function(){return this._y});this.__defineGetter__("w",function(){return this._w});this.__defineGetter__("h",function(){return this._h});this.__defineGetter__("z",function(){return this._z});this.__defineGetter__("rotation",function(){return this._rotation});this.__defineGetter__("alpha",function(){return this._alpha});this.__defineGetter__("visible",function(){return this._visible})}else{if(g.support.defineProperty){Object.defineProperty(this,"x",{set:function(e){this._attr("_x",e)},get:function(){return this._x}});Object.defineProperty(this,"y",{set:function(e){this._attr("_y",e)},get:function(){return this._y}});Object.defineProperty(this,"w",{set:function(e){this._attr("_w",e)},get:function(){return this._w}});Object.defineProperty(this,"h",{set:function(e){this._attr("_h",e)},get:function(){return this._h}});Object.defineProperty(this,"z",{set:function(e){this._attr("_z",e)},get:function(){return this._z}});Object.defineProperty(this,"rotation",{set:function(e){this._attr("_rotation",e)},get:function(){return this._rotation}});Object.defineProperty(this,"alpha",{set:function(e){this._attr("_alpha",e)},get:function(){return this._alpha}});Object.defineProperty(this,"visible",{set:function(e){this._attr("_visible",e)},get:function(){return this._visible}})}else{this.x=this._x;this.y=this._y;this.w=this._w;this.h=this._h;this.z=this._z;this.rotation=this._rotation;this.alpha=this._alpha;this.visible=this._visible;this.bind("enterframe",function(){if(this.x!==this._x||this.y!==this._y||this.w!==this._w||this.h!==this._h||this.z!==this._z||this.rotation!==this._rotation||this.alpha!==this._alpha||this.visible!==this._visible){var e=this.mbr()||this.pos();if(this.rotation!==this._rotation){this._rotate(this.rotation)}else{var k=this._mbr;if(k){if(this.x!==this._x){k._x-=this.x-this._x}else{if(this.y!==this._y){k._y-=this.y-this._y}else{if(this.w!==this._w){k._w-=this.w-this._w}else{if(this.h!==this._h){k._h-=this.h-this._h}else{if(this.z!==this._z){k._z-=this.z-this._z}}}}}}}this._x=this.x;this._y=this.y;this._w=this.w;this._h=this.h;this._z=this.z;this._rotation=this.rotation;this._alpha=this.alpha;this._visible=this.visible;this.trigger("move",e);this.trigger("change",e)}})}}this._entry=g.map.insert(this);g.DrawList.add(this);this.bind("move",function(){var e=this._mbr||this;this._entry.update(e);if(this._x+this._w<0-this.buffer&&this._y+this._h<0-this.buffer&&this._x>g.viewport.width+this.buffer&&this._y>g.viewport.height+this.buffer){g.DrawList.remove(this);this._offscreen=true}if(this._offscreen&&(this._x+this._w>0-this.buffer&&this._y+this._h>0-this.buffer&&this._x<g.viewport.width+this.buffer&&this._y<g.viewport.height+this.buffer)){g.DrawList.add(this);this._offscreen=false}});this.bind("rotate",function(m){var k=this._mbr||this;this._entry.update(k)});this.bind("remove",function(){g.map.remove(this);g.DrawList.remove(this);this.detach()});this.bind("change",function(){g.DrawList.change=true})},_rotate:function(w){var u=-1*(w%360),F=u*h,t=Math.cos(F),y=Math.sin(F),x={x:this._origin.x+this._x,y:this._origin.y+this._y};if(!u){this._mbr=null;if(!this._rotation%360){return}}var C=x.x+(this._x-x.x)*t+(this._y-x.y)*y,p=x.y-(this._x-x.x)*y+(this._y-x.y)*t,B=x.x+(this._x+this._w-x.x)*t+(this._y-x.y)*y,m=x.y-(this._x+this._w-x.x)*y+(this._y-x.y)*t,A=x.x+(this._x+this._w-x.x)*t+(this._y+this._h-x.y)*y,k=x.y-(this._x+this._w-x.x)*y+(this._y+this._h-x.y)*t,z=x.x+(this._x-x.x)*t+(this._y+this._h-x.y)*y,e=x.y-(this._x-x.x)*y+(this._y+this._h-x.y)*t,s=Math.floor(Math.min(C,B,A,z)),q=Math.floor(Math.min(p,m,k,e)),r=Math.ceil(Math.max(C,B,A,z)),n=Math.ceil(Math.max(p,m,k,e));this._mbr={_x:s,_y:q,_w:r-s,_h:n-q};var E=this._rotation-w,D=E*h;this.trigger("rotate",{cos:Math.cos(D),sin:Math.sin(D),deg:E,rad:D,o:{x:x.x,y:x.y}})},area:function(){return this._w*this._h},intersect:function(e,p,k,m){var n,o=this._mbr||this;if(typeof e==="object"){n=e}else{n={x:e,y:p,w:k,h:m}}return o._x<n.x+n.w&&o._x+o._w>n.x&&o._y<n.y+n.h&&o._h+o._y>n.y},within:function(e,o,k,m){var n;if(typeof e==="object"){n=e}else{n={x:e,y:o,w:k,h:m}}return n.x>=this.x&&n.x+n.w<=this.x+this.w&&n.y>=this.y&&n.y+n.h<=this.y+this.h},pos:function(){return{_x:Math.floor(this._x),_y:Math.floor(this._y),_w:Math.floor(this._w),_h:Math.floor(this._h)}},isAt:function(e,k){return this.x<=e&&this.x+this.w>=e&&this.y<=k&&this.y+this.h>=k},move:function(e,k){if(e.charAt(0)==="n"){this.y-=k}if(e.charAt(0)==="s"){this.y+=k}if(e==="e"||e.charAt(1)==="e"){this.x+=k}if(e==="w"||e.charAt(1)==="w"){this.x-=k}return this},shift:function(e,n,k,m){if(e){this.x+=e}if(n){this.y+=n}if(k){this.w+=k}if(m){this.h+=m}return this},attach:function(e){function k(n){if(!n){return}if(n.cos){e.rotate(n)}else{var m=this._mbr||this;dx=m._x-n._x,dy=m._y-n._y,dw=m._w-n._w,dh=m._h-n._h;e.shift(dx,dy,dw,dh)}}this.bind("move",k);this.bind("rotate",k);this._attachy[e[0]]=k;return this},detach:function(n){if(!n){var k,e=this._attachy;for(k in e){if(!e.hasOwnProperty(k)){continue}this.unbind("move",e[k]);this._attachy[k]=null;delete this._attachy[k]}return this}var m=this._attachy[n[0]];this.unbind("move",m);this._attachy[n[0]]=null;delete this._attachy[n[0]];return this},origin:function(e,m){if(typeof e==="string"){if(e==="centre"||e==="center"||e.indexOf(" ")===-1){e=this._w/2;m=this._h/2}else{var k=e.split(" ");if(k[0]==="top"){m=0}else{if(k[0]==="bottom"){m=this._h}else{if(k[0]==="middle"||k[1]==="center"||k[1]==="centre"){m=this._h/2}}}if(k[1]==="center"||k[1]==="centre"||k[1]==="middle"){e=this._w/2}else{if(k[1]==="left"){e=0}else{if(k[1]==="right"){e=this._w}}}}}else{if(e>this._w||m>this._h||e<0||m<0){return this}}this._origin.x=e;this._origin.y=m;return this},mbr:function(){var e=this._mbr;if(!e){return}return{_x:e._x,_y:e._y,_w:e._w,_h:e._h}},rotate:function(k){this._origin.x=k.o.x-this._x;this._origin.y=k.o.y-this._y;this._attr("_rotation",k.theta)},_attr:function(k,m){var o=this.pos(),e=this.mbr()||o;if(k==="_rotation"){this._rotate(m)}else{if(k==="_z"){this._global=parseInt(m+g.zeroFill(this[0],5),10);this.trigger("reorder")}else{if(k==="_visible"){if(m===false){g.DrawList.remove(this)}else{if(m===true){g.DrawList.add(this)}}}else{if(k!=="_alpha"){var n=this._mbr;if(n){n[k]-=this[k]-m}this[k]=m;this.trigger("move",e)}}}}this[k]=m;this.trigger("change",e)}});g.c("gravity",{_gravity:0.2,_gy:0,_falling:true,_anti:null,init:function(){if(!this.has("2D")){this.addComponent("2D")}},gravity:function(e){if(e){this._anti=e}this.bind("enterframe",this._enterframe);return this},_enterframe:function(){if(this._falling){this._gy+=this._gravity*2;this.y+=this._gy}else{this._gy=0}var k=this,e=false;g(this._anti).each(function(){if(this.intersect(k.x,k.y+1,k.w,k.h)&&k!==this){e=this}});if(e){if(this._falling){this.stopFalling(e)}}else{this._falling=true}},stopFalling:function(k){if(k){this.y=k.y-this.h}this._falling=false;if(this.__move&&this.__move.up){this.__move.up=false}this.trigger("hit")},antigravity:function(){this.unbind("enterframe",this._enterframe)}});g.polygon=function(e){if(arguments.length>1){e=Array.prototype.slice.call(arguments,0)}this.points=e};g.polygon.prototype={containsPoint:function(e,q){var n=this.points,m,k,o=false;for(m=0,k=n.length-1;m<n.length;k=m++){if(((n[m][1]>q)!=(n[k][1]>q))&&(e<(n[k][0]-n[m][0])*(q-n[m][1])/(n[k][1]-n[m][1])+n[m][0])){o=!o}}return o},shift:function(e,o){var m=0,k=this.points.length,n;for(;m<k;m++){n=this.points[m];n[0]+=e;n[1]+=o}},rotate:function(p){var n=0,m=this.points.length,o,k,q;for(;n<m;n++){o=this.points[n];k=p.o.x+(o[0]-p.o.x)*p.cos+(o[1]-p.o.y)*p.sin;q=p.o.y-(o[0]-p.o.x)*p.sin+(o[1]-p.o.y)*p.cos;o[0]=Math.floor(k);o[1]=Math.floor(q)}},draw:function(p){var n=0,m=this.points.length,o,k,q;for(;n<m;n++){o=this.points[n];g.e("2D, DOM, color").attr({x:o[0],y:o[1],w:5,h:5}).color("red")}}};ITERATOR=0;g.c("collision",{collision:function(k){if(!k){var e=this._mbr||this;k=new g.polygon([0,0],[e._w,0],[e._w,e._h],[0,e._h]);k.shift(e._x,e._y)}this.map=k;this.attach(this.map);return this},hit:function(s){var k=this._mbr||this,p=g.map.search(k,false),q=0,n=p.length,w={},e,o,r,v,t=("map" in this&&"containsPoint" in this.map),m=[];if(!n){return false}for(;q<n;++q){o=p[q];r=o._mbr||o;if(!o){continue}e=o[0];if(!w[e]&&this[0]!==e&&o.__c[s]&&r._x<k._x+k._w&&r._x+r._w>k._x&&r._y<k._y+k._h&&r._h+r._y>k._y){w[e]=o}}for(v in w){o=w[v];if(t&&"map" in o){var u=this.SAT(this.map,o.map);u.obj=o;u.type="SAT";if(u){m.push(u)}}else{m.push({obj:o,type:"MBR"})}}if(!m.length){return false}return m},onhit:function(e,k){this.bind("enterframe",function(){var m=this.hit(e);if(m){k.call(this,m)}});return this},SAT:function(p,o){var B=p.points,A=o.points,y=0,u=B.length,x,w=A.length,D={x:0,y:0},e,v,s,t,r,C,m=null,q,z,n;for(;y<u;y++){z=B[(y==u-1?0:y+1)];n=B[y];D.x=-(z[1]-n[1]);D.y=(z[0]-n[0]);e=Math.sqrt(D.x*D.x+D.y*D.y);D.x/=e;D.y/=e;v=s=-1;t=r=-1;for(x=0;x<u;++x){q=B[x][0]*D.x+B[x][1]*D.y;if(q>t||t===-1){t=q}if(q<v||v===-1){v=q}}for(x=0;x<w;++x){q=A[x][0]*D.x+A[x][1]*D.y;if(q>r||r===-1){r=q}if(q<s||s===-1){s=q}}C=(v<s)?s-t:v-r;if(C>0){return false}if(C>m||m===null){m=C}}for(y=0;y<w;y++){z=A[(y==w-1?0:y+1)];n=A[y];D.x=-(z[1]-n[1]);D.y=(z[0]-n[0]);e=Math.sqrt(D.x*D.x+D.y*D.y);D.x/=e;D.y/=e;v=s=-1;t=r=-1;for(x=0;x<u;++x){q=B[x][0]*D.x+B[x][1]*D.y;if(q>t||t===-1){t=q}if(q<v||v===-1){v=q}}for(x=0;x<w;++x){q=A[x][0]*D.x+A[x][1]*D.y;if(q>r||r===-1){r=q}if(q<s||s===-1){s=q}}C=(v<s)?s-t:v-r;if(C>0){return false}if(C>m||m===null){m=C}}return{overlap:m}}});g.c("DOM",{_element:null,init:function(){this._element=f.createElement("div");g.stage.elem.appendChild(this._element);this._element.style.position="absolute";this._element.id="ent"+this[0];this.bind("remove",this.undraw)},DOM:function(e){if(!this.has("2D")){this.addComponent("2D")}this._element=e;this._element.style.position="absolute";return this},draw:function(){var k=this._element.style,n;k.top=Math.floor(this._y)+"px";k.left=Math.floor(this._x)+"px";k.width=Math.floor(this._w)+"px";k.height=Math.floor(this._h)+"px";k.zIndex=this._z;k.opacity=this._alpha;if(this._mbr){var m="rotate("+this._rotation+"deg)",e=this._origin.x+"px "+this._origin.y+"px";k.transformOrigin=e;k.mozTransformOrigin=e;k.webkitTransformOrigin=e;k.oTransformOrigin=e;k.transform=m;k.mozTransform=m;k.webkitTransform=m;k.oTransform=m}this.trigger("draw",{style:k,type:"DOM"});if(this.has("sprite")){n=this.__coord;k.background="url('"+this.__image+"') no-repeat -"+n[0]+"px -"+n[1]+"px"}return this},undraw:function(){g.stage.elem.removeChild(this._element);return this},css:function(n){var e,m=this._element,k=m.style;for(e in n){if(!n.hasOwnProperty(e)){continue}k[e]=n[e]}this.trigger("change");return this}});try{f.execCommand("BackgroundImageCache",false,true)}catch(b){}g.extend({window:{init:function(){this.width=c.innerWidth||(c.document.documentElement.clientWidth||c.document.body.clientWidth);this.height=c.innerHeight||(c.document.documentElement.clientHeight||c.document.body.clientHeight)},width:0,height:0},inner:function(o){var n=o.getBoundingClientRect(),e=n.left,p=n.top,m,k;m=parseInt(this.getStyle(o,"border-left-width")||0,10);k=parseInt(this.getStyle(o,"border-top-width")||0,10);if(!m||!k){m=parseInt(this.getStyle(o,"borderLeftWidth")||0,10);k=parseInt(this.getStyle(o,"borderTopWidth")||0,10)}e+=m;p+=k;return{x:e,y:p}},getStyle:function(k,m){var e;if(k.currentStyle){e=k.currentStyle[m]}else{if(c.getComputedStyle){e=f.defaultView.getComputedStyle(k,null).getPropertyValue(m)}}return e}});g.extend({randRange:function(k,e){return Math.round(Math.random()*(e-k)+k)},zeroFill:function(k,e){e-=k.toString().length;if(e>0){return new Array(e+(/\./.test(k)?2:1)).join("0")+k}return k.toString()},sprite:function(q,k,e,n,m){var s,v,t,r,u,p,o;if(typeof q==="string"){e=k;k=q;q=1}if(!m&&n){m=n}n=parseInt(n||0,10);m=parseInt(m||0,10);o=g.assets[k];if(!o){o=new Image();o.src=k;g.assets[k]=o;o.onload=function(){for(var w in e){g(w).each(function(){this.ready=true;this.trigger("change")})}}}for(s in e){if(!e.hasOwnProperty(s)){continue}v=e[s];t=v[0]*q+n;r=v[1]*q+m;u=v[2]*q||q;p=v[3]*q||q;g.c(s,{__image:k,__coord:[t,r,u,p],__tile:q,__padding:[n,m],img:o,ready:false,init:function(){this.addComponent("sprite");if(this.has("canvas")){if(this.img.complete&&this.img.width>0){this.ready=true;this.trigger("change")}}this.w=this.__coord[2];this.h=this.__coord[3]},sprite:function(z,C,A,B){this.__coord=[z*this.__tile+this.__padding[0],C*this.__tile+this.__padding[1],A*this.__tile||this.__tile,B*this.__tile||this.__tile];this.trigger("change")}})}return this},_events:{},addEvent:function(e,o,n,m){if(arguments.length===3){m=n;n=o;o=c.document}var k=function(p){var p=p||c.event;m.call(e,p)};if(!this._events[o+n+m]){this._events[o+n+m]=k}else{return}if(o.attachEvent){o.attachEvent("on"+n,k)}else{o.addEventListener(n,k,false)}},removeEvent:function(e,o,n,m){if(arguments.length===3){m=n;n=o;o=c.document}var k=this._events[o+n+m];if(k){if(o.detachEvent){o.detachEvent("on"+n,k)}else{o.removeEventListener(n,k,false)}delete this._events[o+n+m]}},background:function(e){g.stage.elem.style.background=e},viewport:{width:0,height:0,_x:0,_y:0,scroll:function(m,k){var e=this[m];g("2D obj").each(function(){var n=this.pos();this[m]-=e-k;if(g.support.setter===false){this[m.substr(1)]=this[m]}this.trigger("move",n)});g.DrawList.change=true;this[m]=k},rect:function(){return{_x:this._x,_y:this._y,_w:this.width,_h:this.height}},init:function(e,k){g.window.init();this.width=e||g.window.width;this.height=k||g.window.height;if(!e&&!k){f.body.style.overflow="hidden";g.addEvent(this,c,"resize",function(){g.window.init();var p,q;this.width=p=g.window.width;this.height=q=g.window.height;g.stage.elem.style.width=p;g.stage.elem.style.width=q;if(g._canvas){g._canvas.width=p;g._canvas.height=q}})}var n=f.getElementById("cr-stage");g.stage={x:0,y:0,elem:(n?n:f.createElement("div"))};if(!n){f.body.appendChild(g.stage.elem);g.stage.elem.id="cr-stage"}var m=g.stage.elem.style,o;m.width=this.width+"px";m.height=this.height+"px";m.overflow="hidden";m.position="relative";o=g.inner(g.stage.elem);g.stage.x=o.x;g.stage.y=o.y;if("__defineSetter__" in this&&"__defineGetter__" in this){this.__defineSetter__("x",function(p){this.scroll("_x",p)});this.__defineSetter__("y",function(p){this.scroll("_y",p)});this.__defineGetter__("x",function(){return this._x});this.__defineGetter__("y",function(){return this._y})}else{if("defineProperty" in Object){Object.defineProperty(this,"x",{set:function(p){this.scroll("_x",p)},get:function(){return this._x}});Object.defineProperty(this,"y",{set:function(p){this.scroll("_y",p)},get:function(){return this._y}})}else{this.x=this._x;this.y=this._y;g.e("viewport")}}}},support:{},keys:{BSP:8,TAB:9,ENT:13,SHF:16,CTR:17,ALT:18,PAU:19,CAP:20,ESC:27,SP:32,PGU:33,PGD:34,END:35,HOM:36,LA:37,UA:38,RA:39,DA:40,INS:45,DEL:46,D0:48,D1:49,D2:50,D3:51,D4:52,D5:53,D6:54,D7:55,D8:56,D9:57,SEM:59,EQL:61,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,LWN:91,RWN:92,SEL:93,N0:96,N1:97,N2:98,N3:99,N4:100,N5:101,N6:102,N7:103,N8:104,N9:105,MUL:106,ADD:107,SUB:109,DEC:110,DIV:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM:144,SCR:145,COM:188,PER:190,FSL:191,ACC:192,OBR:219,BSL:220,CBR:221,QOT:222}});g.onload(this,function(){g.support.setter=("__defineSetter__" in this&&"__defineGetter__" in this);g.support.defineProperty=("defineProperty" in Object);g.support.audio=("Audio" in c)});g.c("viewport",{init:function(){this.bind("enterframe",function(){if(g.viewport._x!==g.viewport.x){g.viewport.scroll("_x",g.viewport.x)}if(g.viewport._y!==g.viewport.y){g.viewport.scroll("_y",g.viewport.y)}})}});g.c("canvas",{buffer:50,init:function(){this.bind("reorder",function(){g.DrawList.resort()})},draw:function(){if(!this.ready){return}var n={_x:Math.floor(this._x),_y:Math.floor(this._y),_w:Math.floor(this._w),_h:Math.floor(this._h)},e=g.context;if(this._mbr){e.save();e.translate(this._origin.x+this._x,this._origin.y+this._y);n._x=-this._origin.x;n._y=-this._origin.y;e.rotate((this._rotation%360)*(Math.PI/180))}if(this._alpha>0){var k=e.globalAlpha;e.globalAlpha=this._alpha}if(this.__c.sprite){var m=this.__coord;e.drawImage(this.img,m[0],m[1],m[2],m[3],n._x,n._y,n._w,n._h)}else{this.trigger("draw",{type:"canvas",pos:n})}if(this._mbr){e.restore()}if(this._alpha>0){e.globalAlpha=k}return this}});g.extend({context:null,_canvas:null,canvas:function(){var e=f.createElement("canvas");this.stage.elem.appendChild(e);if(!("getContext" in e)){g.trigger("nocanvas");return}this.context=e.getContext("2d");this._canvas=e;e.width=this.viewport.width;e.height=this.viewport.height;e.style.position="absolute"}});g.extend({down:null,over:null,mouseDispatch:function(p){if(p.type==="touchstart"){p.type="mousedown"}else{if(p.type==="touchmove"){p.type="mousemove"}else{if(p.type==="touchend"){p.type="mouseup"}}}var s=-1,m,k,o=0,n;k=g.map.search(g.viewport.rect());for(n=k.length;o<n;++o){if(!k[o].has("mouse")){continue}var r=k[o],t=false,v=p.clientX-g.stage.x,u=p.clientY-g.stage.y;if(r.map){if(r.map.containsPoint(v,u)){t=true}}else{if(r.isAt(v,u)){t=true}}if(t&&(r._z>=s||s===-1)){if(r._z===s&&r[0]<m[0]){continue}s=r._z;m=r}}if(m){if(p.type==="mousedown"){this.down=m}if(p.type==="mouseup"){if(this.down&&m===this.down){this.down.trigger("click",p);this.down=null;return}this.down=null}if(p.type==="mousemove"){if(this.over!==m){if(this.over){this.over.trigger("mouseout",p);this.over=null}this.over=m;m.trigger("mouseover",p);return}}m.trigger(p.type,p)}else{if(p.type==="mousemove"&&this.over){this.over.trigger("mouseout",p);this.over=null}}}});g.onload(this,function(){g.addEvent(this,g.stage.elem,"mousedown",g.mouseDispatch);g.addEvent(this,g.stage.elem,"mouseup",g.mouseDispatch);g.addEvent(this,g.stage.elem,"mousemove",g.mouseDispatch);g.addEvent(this,g.stage.elem,"touchstart",g.mouseDispatch);g.addEvent(this,g.stage.elem,"touchmove",g.mouseDispatch);g.addEvent(this,g.stage.elem,"touchend",g.mouseDispatch)});g.c("mouse",{areaMap:function(k){if(arguments.length>1){var e=Array.prototype.slice.call(arguments,0);k=new g.polygon(e)}k.shift(this._x,this._y);this.map=k;this.attach(this.map);return this}});g.c("draggable",{_startX:0,_startY:0,init:function(){if(!this.has("mouse")){this.addComponent("mouse")}function e(k){this.x=k.clientX-this._startX;this.y=k.clientY-this._startY}this.bind("mousedown",function(k){this._startX=(k.clientX-g.stage.x)-this._x;this._startY=(k.clientY-g.stage.y)-this._y;g.addEvent(this,g.stage.elem,"mousemove",e)});g.addEvent(this,g.stage.elem,"mouseup",function(){g.removeEvent(this,g.stage.elem,"mousemove",e)})},disable:function(){this.unbind("mousedown")}});g.c("controls",{init:function(){function e(k){k.key=k.keyCode||k.which;this.trigger(k.type,k)}g.addEvent(this,"keydown",e);g.addEvent(this,"keyup",e);this.bind("remove",function(){g.removeEvent(this,"keydown",e);g.removeEvent(this,"keyup",e)})},preventTypeaheadFind:function(k){if(!(k.metaKey||k.altKey||k.shiftKey||k.ctrlKey)&&k.preventDefault){k.preventDefault()}return this}});g.c("fourway",{__move:{left:false,right:false,up:false,down:false},_speed:3,init:function(){if(!this.has("controls")){this.addComponent("controls")}},fourway:function(k){if(k){this._speed=k}var e=this.__move;this.bind("enterframe",function(){var m=this.pos(),n=false;if(e.right){this.x+=this._speed;n=true}if(e.left){this.x-=this._speed;n=true}if(e.up){this.y-=this._speed;n=true}if(e.down){this.y+=this._speed;n=true}}).bind("keydown",function(m){if(m.keyCode===g.keys.RA||m.keyCode===g.keys.D){e.right=true}if(m.keyCode===g.keys.LA||m.keyCode===g.keys.A){e.left=true}if(m.keyCode===g.keys.UA||m.keyCode===g.keys.W){e.up=true}if(m.keyCode===g.keys.DA||m.keyCode===g.keys.S){e.down=true}this.preventTypeaheadFind(m)}).bind("keyup",function(m){if(m.keyCode===g.keys.RA||m.keyCode===g.keys.D){e.right=false}if(m.keyCode===g.keys.LA||m.keyCode===g.keys.A){e.left=false}if(m.keyCode===g.keys.UA||m.keyCode===g.keys.W){e.up=false}if(m.keyCode===g.keys.DA||m.keyCode===g.keys.S){e.down=false}this.preventTypeaheadFind(m)});return this}});g.c("twoway",{__move:{left:false,right:false,up:false,falling:false},_speed:3,init:function(){if(!this.has("controls")){this.addComponent("controls")}},twoway:function(m,k){if(m){this._speed=m}k=k||this._speed*2;var e=this.__move;this.bind("enterframe",function(){var n=this.pos(),o=false;if(e.right){this.x+=this._speed;o=true}if(e.left){this.x-=this._speed;o=true}if(e.up){this.y-=k;this._falling=true;o=true}}).bind("keydown",function(n){if(n.keyCode===g.keys.RA||n.keyCode===g.keys.D){e.right=true}if(n.keyCode===g.keys.LA||n.keyCode===g.keys.A){e.left=true}if(n.keyCode===g.keys.UA||n.keyCode===g.keys.W){e.up=true}}).bind("keyup",function(n){if(n.keyCode===g.keys.RA||n.keyCode===g.keys.D){e.right=false}if(n.keyCode===g.keys.LA||n.keyCode===g.keys.A){e.left=false}});return this}});g.c("animate",{_reels:{},_frame:null,_current:null,animate:function(e,n,s,o){if(arguments.length===2&&typeof n==="number"){this._current=e;var m=this._reels[e],k=n;this._frame={reel:m,frameTime:Math.ceil(k/m.length),frame:0,current:0};this.bind("enterframe",this.drawFrame);return this}if(typeof n==="number"){var r=o+1-n,p=n,m=[],q=this.__tile;for(;p<=o;p++){m.push([p*q,s*q])}this._reels[e]=m}else{if(typeof n==="object"){this._reels[e]=n}}return this},drawFrame:function(m){var k=this._frame;if(this._frame.current++===k.frameTime){var n=k.reel[k.frame++];this.__coord[0]=n[0];this.__coord[1]=n[1];this._frame.current=0}if(k.frame===k.reel.length&&this._frame.current===k.frameTime){k.frame=0;this.stop();return}this.trigger("change")},stop:function(){this.unbind("enterframe",this.drawFrame);this._current=null;this._frame=null;return this},isPlaying:function(e){if(!e){return !!this._interval}return this._current===e}});g.c("color",{_color:"",ready:true,init:function(){this.bind("draw",function(k){if(k.type==="DOM"){k.style.background=this._color;k.style.lineHeight=0}else{if(k.type==="canvas"){if(this._color){g.context.fillStyle=this._color}g.context.fillRect(k.pos._x,k.pos._y,k.pos._w,k.pos._h)}}})},color:function(e){this._color=e;this.trigger("change");return this}});g.c("image",{_repeat:"repeat",ready:false,init:function(){this.bind("draw",function(k){if(k.type==="canvas"){this.canvasDraw(k)}else{if(k.type==="DOM"){if(this.__image){k.style.background="url("+this.__image+") "+this._repeat}}}})},image:function(k,m){this.__image=k;this._repeat=m||"repeat";if(this.has("canvas")){this.img=g.assets[k];if(!this.img){this.img=new Image();g.assets[k]=this.img;this.img.src=k;var e=this;this.img.onload=function(){e._pattern=g.context.createPattern(e.img,e._repeat);e.ready=true;e.trigger("change")};return this}else{this.ready=true;this._pattern=g.context.createPattern(this.img,this._repeat)}}this.trigger("change");return this},canvasDraw:function(m){if(!this.ready||!this._pattern){return}var k=g.context;k.fillStyle=this._pattern;k.save();k.translate(m.pos._x,m.pos._y);k.fillRect(0,0,m.pos._w,m.pos._h);k.restore()}});g.extend({_scenes:[],_current:null,scene:function(e,k){if(arguments.length===1){g("2D").each(function(){if(!this.has("persist")){this.destroy()}});this._scenes[e].call(this);this._current=e;return}this._scenes[e]=k;return}});g.DrawList=(function(){var n=[];if(!Array.prototype.indexOf){Array.prototype.indexOf=function(r,s){for(var q=(s||0),p=this.length;q<p;q++){if(this[q]==r){return q}}return -1}}return{add:function o(p){if(n.indexOf(p)===-1){n.push(p);n.sort(function(r,q){return r._global-q._global})}},remove:function k(q){var p=n.indexOf(q);if(p!==-1){n.splice(p,1)}},draw:function e(){if(!this.change){return}if(g.context){g.context.clearRect(0,0,g._canvas.width,g._canvas.height)}var q=0,p=n.length;for(;q<p;q++){if(!n[q]||!("draw" in n[q])){this.remove(n[q]);continue}n[q].draw()}this.change=false},resort:function m(){n.sort(function(q,p){return q._global-p._global})},debug:function(){return n},change:false}})();g.c("group",{_children:[],group:function(e){this._children=e;this.bind("move",function(s){var n=s._x-this.x,m=s._y-this.y,o=s._w-this.w,q=s._h-this.h,p=0,k=this._children.length,r;for(;p<k;p++){r=this._children[p];if(n){r.x-=n}if(m){r.y-=m}if(o){r.w-=o}if(q){r.h-=q}}});this.bind("remove",function(){var m=0,k=this._children.length,n;for(;m<k;m++){n.destroy()}});return this}});g.extend({group:function(){var s=g.e("2D, group"),q=Array.prototype.slice.call(arguments),o=0,m=q.length,n,e,k,r,p;for(;o<m;o++){p=q[o];p.removeComponent("obj");if(p.x<n||!n){n=p.x}if(p.x+p.w>n+e||!e){e=p.x+p.w-n}if(p.y<k||!k){k=p.y}if(p.y+p.h<k+r||!r){r=p.y+p.h-k}}s.attr({x:n,y:k,w:e,h:r}).group(q);return s}});g.extend({isometric:{_tile:0,_z:0,init:function(e){this._tile=e;return this},place:function(k,r,p,o){var e=k*this._tile+(r&1)*(this._tile/2),q=r*this._tile/4,q=q-p*(this._tile/2);o.attr({x:e+g.viewport._x,y:q+g.viewport._y}).z+=p;return this},zoom:function(e){this._tile=e;g.trigger("zoom",{tile:e});return this}}});g.extend({audio:{_elems:{},MAX_CHANNELS:5,type:{mp3:"audio/mpeg;",ogg:'audio/ogg; codecs="vorbis"',wav:'audio/wav; codecs="1"',mp4:'audio/mp4; codecs="mp4a.40.2"'},add:function(n,m){if(!g.support.audio){return}var q,u,s=new Audio(),o,t=0,p=[];if(arguments.length===1&&typeof n==="object"){for(u in n){if(!n.hasOwnProperty(u)){continue}if(typeof n[u]!=="string"){var k=n[u],t=0,r=k.length,e;for(;t<r;++t){e=k[t];ext=e.substr(e.lastIndexOf(".")+1).toLowerCase();o=s.canPlayType(this.type[ext]);if(o!==""&&o!=="no"){m=e;break}}}else{m=n[u]}for(;t<this.MAX_CHANNELS;t++){s=new Audio(m);s.preload="auto";s.load();p.push(s)}this._elems[u]=p;if(!g.assets[m]){g.assets[m]=this._elems[u][0]}}return this}if(typeof m!=="string"){var t=0,r=m.length,e;for(;t<r;++t){e=m[t];ext=e.substr(e.lastIndexOf(".")+1);o=s.canPlayType(this.type[ext]);if(o!==""&&o!=="no"){m=e;break}}}for(;t<this.MAX_CHANNELS;t++){s=new Audio(m);s.preload="auto";s.load();p.push(s)}this._elems[u]=p;if(!g.assets[m]){g.assets[m]=this._elems[u][0]}return this},play:function(o){if(!g.support.audio){return}var e=this._elems[o],n,m=0,k=e.length;for(;m<k;m++){n=e[m];if(n.ended||!n.currentTime){n.play();break}else{if(m===k-1){n.currentTime=0;n.play()}}}return this},settings:function(r,p){if(!p){for(var n in this._elems){this.settings(n,r)}return this}var e=this._elems[r],q,o,m=0,k=e.length;for(var o in p){for(;m<k;m++){q=e[m];q[o]=p[o]}}return this}}});g.c("text",{_text:"",_font:"",init:function(){this.bind("draw",function(n){if(n.type==="DOM"){var m=this._element,k=m.style;m.innerHTML=this._text;k.font=this._font}else{}})},text:function(e){if(!e){return this._text}this._text=e;this.trigger("change");return this},font:function(e){this._font=e;this.trigger("change");return this}});g.c("health",{_mana:100,health:function(e){this._mana=e;return this},hurt:function(e){this._mana-=e;this.trigger("hurt",{by:e,mana:this._mana});if(this._mana<=0){this.trigger("die")}return this},heal:function(e){this._mana+=e;this.trigger("heal");return this}});g.c("score",{_score:0,incrementScore:function(e){this._score+=e;return this},decrementScore:function(e){this._score-=e;return this}});g.extend({assets:{},load:function(p,k,e,s){var q=0,m=p.length,r,o,t=m,n=0;for(;q<m;++q){r=p[q];ext=r.substr(r.lastIndexOf(".")+1).toLowerCase();if(g.support.audio&&(ext==="mp3"||ext==="wav"||ext==="ogg"||ext==="mp4")){o=new Audio(r)}else{if(ext==="jpg"||ext==="jpeg"||ext==="gif"||ext==="png"){o=new Image();o.src=r}else{t--;continue}}this.assets[r]=o;o.onload=function(){++n;if(e){e.call(this,{loaded:n,total:t,percent:(n/t*100)})}if(n===t){if(k){k()}}};o.onerror=function(){if(s){s.call(this,{loaded:n,total:t,percent:(n/t*100)})}}}}})})(Crafty,window,window.document);